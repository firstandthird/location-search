/*!
 * location-search - Lib to add location autocomplete to a input box
 * v0.2.2
 * https://github.com/firstandthird/location-search
 * copyright First+Third 2014
 * MIT License
*/
!function(a,b){var c=0,d=function(a){this.obj=a};d.prototype.__init=function(a){b.extend(this,this.obj),this.id=c++,this.namespace=".fidel"+this.id,this.obj.defaults=this.obj.defaults||{},b.extend(this,this.obj.defaults,a),b("body").trigger("FidelPreInit",this),this.setElement(this.el||b("<div/>")),this.init&&this.init(),b("body").trigger("FidelPostInit",this)},d.prototype.eventSplitter=/^(\w+)\s*(.*)$/,d.prototype.setElement=function(a){this.el=a,this.getElements(),this.dataElements(),this.delegateEvents(),this.delegateActions()},d.prototype.find=function(a){return this.el.find(a)},d.prototype.proxy=function(a){return b.proxy(a,this)},d.prototype.getElements=function(){if(this.elements)for(var a in this.elements){var b=this.elements[a];this[b]=this.find(a)}},d.prototype.dataElements=function(){var a=this;this.find("[data-element]").each(function(c,d){var e=b(d),f=e.data("element");a[f]=e})},d.prototype.delegateEvents=function(){if(this.events)for(var a in this.events){var b=this.events[a],c=a.match(this.eventSplitter),d=c[1],e=c[2],f=this.proxy(this[b]);""===e?this.el.on(d+this.namespace,f):this[e]&&"function"!=typeof this[e]?this[e].on(d+this.namespace,f):this.el.on(d+this.namespace,e,f)}},d.prototype.delegateActions=function(){var a=this;a.el.on("click"+this.namespace,"[data-action]",function(c){var d=b(this),e=d.attr("data-action");a[e]&&a[e](c,d)})},d.prototype.on=function(a,b){this.el.on(a+this.namespace,b)},d.prototype.one=function(a,b){this.el.one(a+this.namespace,b)},d.prototype.emit=function(a,b,c){var d=c?this.namespace:"";this.el.trigger(a+d,b)},d.prototype.hide=function(){if(this.views)for(var a in this.views)this.views[a].hide();this.el.hide()},d.prototype.show=function(){if(this.views)for(var a in this.views)this.views[a].show();this.el.show()},d.prototype.destroy=function(){this.el.empty(),this.emit("destroy"),this.el.unbind(this.namespace)},d.declare=function(a){var b=function(a,b){this.__init(a,b)};return b.prototype=new d(a),b},d.onPreInit=function(a){b("body").on("FidelPreInit",function(b,c){a.call(c)})},d.onPostInit=function(a){b("body").on("FidelPostInit",function(b,c){a.call(c)})},a.Fidel=d}(window,window.jQuery||window.Zepto),function(a){a.declare=function(b,c){a.fn[b]=function(){var d,e,f=Array.prototype.slice.call(arguments),g=f.shift();return e=this.each(function(){var e=a(this),h=e.data(b);if(!h){var i=Fidel.declare(c),j=a.extend({},g,{el:e});h=new i(j),e.data(b,h)}"string"==typeof g&&(d=h[g].apply(h,f))}),"undefined"!=typeof d?d:e},a.fn[b].defaults=c.defaults||{}},a.Fidel=window.Fidel}(jQuery),function(a){function b(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}a.declare("complete",{defaults:{search:function(a,b,c){return-1!==this._getSuggestion(a).toLowerCase().indexOf(c.toLowerCase())},listClass:"complete",suggestionActiveClass:"complete-active",suggestionClass:"complete-suggestion",maxHeight:142,minChars:0,zIndex:99999,delay:300,allowOthers:!1,sourceKey:null,showOnClick:!0,keepOpen:!1,formatSuggestion:function(a,c){var d="("+b(c)+")";return this._getSuggestion(a).replace(new RegExp(d,"gi"),"<strong>$1</strong>")},query:function(b,c){var d=b.toLowerCase(),e=this,f=a.grep(this.source,function(a){return e.search(a,b,d)});c.call(this,f)}},events:{keydown:"keyPressed",keyup:"keyUp",blur:"onBlur",focus:"onFocus",click:"valueChanged"},keyCode:{UP:38,DOWN:40,TAB:9,ENTER:13,ESC:27},init:function(){a(this.el).attr("autocomplete","off"),this.createListHolder(),this.visible=!1,this.currentValue=this.el.value,this.selectedIndex=-1,this.suggestions=[]},_getSuggestion:function(a){var b;return b=this.sourceKey&&a&&a[this.sourceKey]?a[this.sourceKey]:a},debounce:function(a){var b=this,c=arguments;this.delay>0?(clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(function(){a.apply(b,c)},this.delay)):a.apply(this,c)},createListHolder:function(){var b=a(this.el);this.listHolder=a("<div>").addClass(this.listClass).hide().insertAfter(b),this.list=a("<ul>"),this.list.appendTo(this.listHolder),a(this.listHolder).css({width:b.outerWidth(),top:b.position().top+b.outerHeight(),left:b.position().left,"max-height":this.maxHeight,"z-index":this.zIndex}),this.bindEventsList()},updatePosition:function(){var b=a(this.el);a(this.listHolder).css({top:b.position().top+b.outerHeight(),left:b.position().left})},bindEventsList:function(){var b=a(this.list),c=this;b.on("mouseover","li",function(a){var b=c._getTarget(a);c.activateSuggestion.apply(c,[b.data("index")])}),b.on("mouseout","li",this.proxy(this.deActivateSuggestion,this)),b.on("click","li",this.proxy(this.selectSuggestion,this))},keyPressed:function(a){var b=!0;switch(a.keyCode){case this.keyCode.UP:this._prevSuggestion();break;case this.keyCode.DOWN:this._nextSuggestion();break;case this.keyCode.ESC:this.el.val(this.currentValue),this.hide();break;case this.keyCode.TAB:case this.keyCode.ENTER:b=!1,this.selectSuggestion(a);break;default:return}b||(a.stopImmediatePropagation(),a.preventDefault())},keyUp:function(a){switch(a.keyCode){case this.keyCode.UP:case this.keyCode.DOWN:case this.keyCode.ENTER:return}this._generatedSuggestions=!1,this.debounce(this.valueChanged)},onBlur:function(){a(document).on("click.complete",this.proxy(this.onClickWA,this))},onFocus:function(){this.updatePosition()},onClickWA:function(b){this.keepOpen||0!==a(b.target).closest("."+this.listClass).length?this.emit("complete:outsideclick"):(this.hide(),a(document).off("click.complete"))},valueChanged:function(b){(this._getSuggestion(this.currentValue)!==a(this.el).val()||"undefined"!=typeof b&&this.showOnClick)&&(this.el.value=a.trim(a(this.el).val()),this.currentValue=this.el.value,this.selectedIndex=-1,this.currentValue.length>=this.minChars?this.show():this.hide()),this._generatedSuggestions=!0},_getSuggestions:function(b){var c=b.toLowerCase(),d=this;return a.grep(this.source,function(a){return d.search(a,b,c)})},_nextSuggestion:function(){var a=this.selectedIndex;!this.visible&&this.currentValue?this.show():a!==this.suggestions.length-1&&this._adjustPosition(a+1)},_prevSuggestion:function(){var a=this.selectedIndex;-1!==a&&this._adjustPosition(a-1)},_adjustPosition:function(b){var c,d,e,f,g=this.activateSuggestion(b),h=a(this.listHolder);g&&(c=g.offsetTop,d=h.scrollTop(),f=a(this.list).children().first().outerHeight(),e=d+this.maxHeight-f,d>c?h.scrollTop(c):c>e&&h.scrollTop(c-this.maxHeight+f),a(this.el).val(this._getSuggestion(this.suggestions[b])))},hide:function(){this.visible=!1,a(this.listHolder).hide()},show:function(){var b=this;this.query.call(b,this.currentValue,function(c){if(b.emit("complete:query",c),c&&a.isArray(c)&&c.length){b.visible=!0;var d=b.currentValue,e=b.suggestionClass,f="";b.suggestions=[],b.suggestions=c,a.each(c,function(a,c){f+='<li class="'+e+'" data-index="'+a+'">'+b.formatSuggestion(c,d)+"</li>"}),a(b.list).html(f),a(b.listHolder).show()}else a(b.list).empty(),b.suggestions=[],b.hide()})},activateSuggestion:function(b){var c=this.suggestionActiveClass,d=a(this.list);return d.children("."+c).removeClass(c),this.selectedIndex=b,-1!==b&&d.children().length>b?a(d.children().get(b)).addClass(c):void 0},deActivateSuggestion:function(a){this._getTarget(a).removeClass(this.suggestionActiveClass),this.selectedIndex=-1},selectSuggestion:function(b){if(this._generatedSuggestions||this.valueChanged(),"keydown"===b.type&&this.allowOthers&&this.selectedIndex<0){var c=this._getSuggestion(this.suggestions[0]);1===this.suggestions.length&&c===this.currentValue?(this.currentValue=this.suggestions[0],a(this.el).val(this._getSuggestion(this.currentValue))):a(this.el).val(this.currentValue),this.emit("complete:select",this.currentValue),this.hide()}else-1===this.selectedIndex&&(this.selectedIndex=0),this.suggestions[this.selectedIndex]&&(a(this.el).val(this._getSuggestion(this.suggestions[this.selectedIndex])),this.currentValue=this.suggestions[this.selectedIndex],this.emit("complete:select",this.currentValue),this.hide())},_getTarget:function(b){return a(b.currentTarget||b.toElement)},setSource:function(a){this.source=a}})}(jQuery),$.fn.locationSearch=function(a){a=a||{};var b=function(a,b,c){var d=new google.maps.places.AutocompleteService(null);b=b||["(cities)"],d.getPlacePredictions({input:a,types:b},function(a,b){if("OK"==b){for(var d=[],e=0;5>e;++e)if(a[e]){var f=a[e];d.push({place:f.description})}c(d)}})},c=function(a,b){var c=new google.maps.Geocoder;c.geocode({address:a},function(a,c){if("OK"!=c)return b(!0);var d=a[0];b(null,{lat:d.geometry.location.lat(),lng:d.geometry.location.lng(),address:d.formatted_address,addressObj:d.address_components})})};return this.each(function(){var d=$(this);d.complete({keepOpen:!0,sourceKey:"place",listWidth:a.listWidth||!1,query:function(c,d){var e=this;""!==c&&b(c,a.types,function(a){d.call(e,a)})}}).on("complete:select",function(a,b){c(b.place,function(a,b){d.trigger("location:select",b)})})})};